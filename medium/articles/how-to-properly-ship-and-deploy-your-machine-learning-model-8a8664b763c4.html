<article class="meteredContent"><div class="l"><div class="gg gh gi gj gk gl gm ce gn ch l"></div><div class="l"><header class="pw-post-byline-header go gp gq gr gs gt gu gv gw gx l"><div class="o gy u"><div class="o"><div class="fj l"><a class="au av aw ax ay az ba bb bc bd be bf bg bh bi" href="https://medium.com/@tivadar.danka?source=post_page-----8a8664b763c4--------------------------------" rel="noopener follow"><div class="l do"><img alt="Tivadar Danka" class="l ch fl gz ha fp" height="48" loading="lazy" src="https://miro.medium.com/fit/c/96/96/1*WisIbfNMKREQZ_gzXV8F0w.png" width="48"/><div class="fk fl l gz ha fo aq"></div></div></a></div><div class="l"><div class="pw-author bm b dm dn ga"><div class="hb o hc"><div><div aria-hidden="false" class="ci"><a class="au av aw ax ay az ba bb bc bd be bf bg bh bi" href="https://medium.com/@tivadar.danka?source=post_page-----8a8664b763c4--------------------------------" rel="noopener follow">Tivadar Danka</a></div></div><div class="hd he hf hg hh d"><span><a class="bm b hi bo hj hk hl hm hn ho hp bd bz hq hr hs cd cf cg ch ci cj" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F26fd873de5f2&amp;operation=register&amp;redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-properly-ship-and-deploy-your-machine-learning-model-8a8664b763c4&amp;user=Tivadar+Danka&amp;userId=26fd873de5f2&amp;source=post_page-26fd873de5f2----8a8664b763c4---------------------follow_byline-----------" rel="noopener follow">Follow</a></span></div></div></div><div class="o ao ht"><p class="pw-published-date bm b bn bo cn"><span>Jan 29, 2020</span></p><div aria-hidden="true" class="hu ci"><span aria-hidden="true" class="l"><span class="bm b bn bo cn">·</span></span></div><div class="pw-reading-time bm b bn bo cn">18 min read</div><div aria-hidden="true" class="hu ci"><span aria-hidden="true" class="l"><span class="bm b bn bo cn">·</span></span></div><div class="hx l"><div aria-hidden="false" class="l"><button class="l dz hv bb"><div class="j i d"><div><div aria-hidden="false" class="ci"><svg fill="none" height="20" viewbox="0 0 20 20" width="20"><path d="M12.4 12.77l-1.81 4.99a.63.63 0 0 1-1.18 0l-1.8-4.99a.63.63 0 0 0-.38-.37l-4.99-1.81a.62.62 0 0 1 0-1.18l4.99-1.8a.63.63 0 0 0 .37-.38l1.81-4.99a.63.63 0 0 1 1.18 0l1.8 4.99a.63.63 0 0 0 .38.37l4.99 1.81a.63.63 0 0 1 0 1.18l-4.99 1.8a.63.63 0 0 0-.37.38z" fill="#FFC017"></path></svg></div></div></div><div class="h k hy hz ia"><svg class="hw" fill="none" height="20" viewbox="0 0 20 20" width="20"><path d="M12.4 12.77l-1.81 4.99a.63.63 0 0 1-1.18 0l-1.8-4.99a.63.63 0 0 0-.38-.37l-4.99-1.81a.62.62 0 0 1 0-1.18l4.99-1.8a.63.63 0 0 0 .37-.38l1.81-4.99a.63.63 0 0 1 1.18 0l1.8 4.99a.63.63 0 0 0 .38.37l4.99 1.81a.63.63 0 0 1 0 1.18l-4.99 1.8a.63.63 0 0 0-.37.38z" fill="#FFC017"></path></svg><p class="bm b bn bo cn">Member-only</p></div></button></div></div></div></div></div><div class="o ao"><div class="h k ib ic id"><div class="ie l fr"><div><div aria-hidden="false" class="ci"><button aria-label="Share on twitter" class="au av aw ax ay az ba bb bc bd be bf bg bh bi"><span class="ci if dw ig"><svg fill="none" height="24" viewbox="0 0 24 24" width="24"><path d="M20 5.34c-.67.41-1.4.7-2.18.87a3.45 3.45 0 0 0-5.02-.1 3.49 3.49 0 0 0-1.02 2.47c0 .28.03.54.07.8a9.91 9.91 0 0 1-7.17-3.66 3.9 3.9 0 0 0-.5 1.74 3.6 3.6 0 0 0 1.56 2.92 3.36 3.36 0 0 1-1.55-.44V10c0 1.67 1.2 3.08 2.8 3.42-.3.06-.6.1-.94.12l-.62-.06a3.5 3.5 0 0 0 3.24 2.43 7.34 7.34 0 0 1-4.36 1.49l-.81-.05a9.96 9.96 0 0 0 5.36 1.56c6.4 0 9.91-5.32 9.9-9.9v-.5c.69-.49 1.28-1.1 1.74-1.81-.63.3-1.3.48-2 .56A3.33 3.33 0 0 0 20 5.33" fill="#A8A8A8"></path></svg></span></button></div></div></div><div class="ie l fr"><div><div aria-hidden="false" class="ci"><button aria-label="Share on facebook" class="au av aw ax ay az ba bb bc bd be bf bg bh bi"><span class="ci if dw ig"><svg fill="none" height="24" viewbox="0 0 24 24" width="24"><path d="M19.75 12.04c0-4.3-3.47-7.79-7.75-7.79a7.77 7.77 0 0 0-5.9 12.84 7.77 7.77 0 0 0 4.69 2.63v-5.49h-1.9v-2.2h1.9v-1.62c0-1.88 1.14-2.9 2.8-2.9.8 0 1.49.06 1.69.08v1.97h-1.15c-.91 0-1.1.43-1.1 1.07v1.4h2.17l-.28 2.2h-1.88v5.52a7.77 7.77 0 0 0 6.7-7.71" fill="#A8A8A8"></path></svg></span></button></div></div></div><div class="ie l fr"><div><div aria-hidden="false" class="ci"><button aria-label="Share on linkedin" class="au av aw ax ay az ba bb bc bd be bf bg bh bi"><span class="ci if dw ig"><svg fill="none" height="24" viewbox="0 0 24 24" width="24"><path d="M19.75 5.39v13.22a1.14 1.14 0 0 1-1.14 1.14H5.39a1.14 1.14 0 0 1-1.14-1.14V5.39a1.14 1.14 0 0 1 1.14-1.14h13.22a1.14 1.14 0 0 1 1.14 1.14zM8.81 10.18H6.53v7.3H8.8v-7.3zM9 7.67a1.31 1.31 0 0 0-1.3-1.32h-.04a1.32 1.32 0 0 0 0 2.64A1.31 1.31 0 0 0 9 7.71v-.04zm8.46 5.37c0-2.2-1.4-3.05-2.78-3.05a2.6 2.6 0 0 0-2.3 1.18h-.07v-1h-2.14v7.3h2.28V13.6a1.51 1.51 0 0 1 1.36-1.63h.09c.72 0 1.26.45 1.26 1.6v3.91h2.28l.02-4.43z" fill="#A8A8A8"></path></svg></span></button></div></div></div><div class="l fr"><div><div aria-hidden="false" class="ci"><button class="au av aw ax ay az ba bb bc bd be bf bg bh bi"><span class="ci if dw ig"><svg fill="none" height="24" viewbox="0 0 24 24" width="24"><path clip-rule="evenodd" d="M3.57 14.67c0-.57.13-1.11.38-1.6l.02-.02v-.02l.02-.02c0-.02 0-.02.02-.02.12-.26.3-.52.57-.8L7.78 9v-.02l.01-.02c.44-.41.91-.7 1.44-.85a4.87 4.87 0 0 0-1.19 2.36A5.04 5.04 0 0 0 8 11.6L6.04 13.6c-.19.19-.32.4-.38.65a2 2 0 0 0 0 .9c.08.2.2.4.38.57l1.29 1.31c.27.28.62.42 1.03.42.42 0 .78-.14 1.06-.42l1.23-1.25.79-.78 1.15-1.16c.08-.09.19-.22.28-.4.1-.2.15-.42.15-.67 0-.16-.02-.3-.06-.45l-.02-.02v-.02l-.07-.14s0-.03-.04-.06l-.06-.13-.02-.02c0-.02 0-.03-.02-.05a.6.6 0 0 0-.14-.16l-.48-.5c0-.04.02-.1.04-.15l.06-.12 1.17-1.14.09-.09.56.57c.02.04.08.1.16.18l.05.04.03.06.04.05.03.04.04.06.1.14.02.02c0 .02.01.03.03.04l.1.2v.02c.1.16.2.38.3.68a1 1 0 0 1 .04.25 3.2 3.2 0 0 1 .02 1.33 3.49 3.49 0 0 1-.95 1.87l-.66.67-.97.97-1.56 1.57a3.4 3.4 0 0 1-2.47 1.02c-.97 0-1.8-.34-2.49-1.03l-1.3-1.3a3.55 3.55 0 0 1-1-2.51v-.01h-.02v.02zm5.39-3.43c0-.19.02-.4.07-.63.13-.74.44-1.37.95-1.87l.66-.67.97-.98 1.56-1.56c.68-.69 1.5-1.03 2.47-1.03.97 0 1.8.34 2.48 1.02l1.3 1.32a3.48 3.48 0 0 1 1 2.48c0 .58-.11 1.11-.37 1.6l-.02.02v.02l-.02.04c-.14.27-.35.54-.6.8L16.23 15l-.01.02-.01.02c-.44.42-.92.7-1.43.83a4.55 4.55 0 0 0 1.23-3.52L18 10.38c.18-.21.3-.42.35-.65a2.03 2.03 0 0 0-.01-.9 1.96 1.96 0 0 0-.36-.58l-1.3-1.3a1.49 1.49 0 0 0-1.06-.42c-.42 0-.77.14-1.06.4l-1.2 1.27-.8.8-1.16 1.15c-.08.08-.18.21-.29.4a1.66 1.66 0 0 0-.08 1.12l.02.03v.02l.06.14s.01.03.05.06l.06.13.02.02.01.02.01.02c.05.08.1.13.14.16l.47.5c0 .04-.02.09-.04.15l-.06.12-1.15 1.15-.1.08-.56-.56a2.3 2.3 0 0 0-.18-.19c-.02-.01-.02-.03-.02-.04l-.02-.02a.37.37 0 0 1-.1-.12c-.03-.03-.05-.04-.05-.06l-.1-.15-.02-.02-.02-.04-.08-.17v-.02a5.1 5.1 0 0 1-.28-.69 1.03 1.03 0 0 1-.04-.26c-.06-.23-.1-.46-.1-.7v.01z" fill="#A8A8A8" fill-rule="evenodd"></path></svg></span></button></div></div></div><div class="ih o ao"><span><a class="au av aw ax ay az ba bb bc bd be bf bg bh bi" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8a8664b763c4&amp;operation=register&amp;redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-properly-ship-and-deploy-your-machine-learning-model-8a8664b763c4&amp;source=--------------------------bookmark_header-----------" rel="noopener follow"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" class="au de aw ax ay az ba if bc hv ij ik il"><svg aria-label="Add to list bookmark button" class="ii" fill="none" height="25" viewbox="0 0 25 25" width="25"><path d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18V2.5zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4V7z" fill="#292929"></path></svg></button></a></span></div></div><div class="ck im"><div><div aria-hidden="false" class="ci"></div></div></div></div></div><div class="in io ip j i d"><div class="fj l"><span><a class="au av aw ax ay az ba bb bc bd be bf bg bh bi" href="https://medium.com/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2F8a8664b763c4&amp;operation=register&amp;redirect=https%3A%2F%2Ftowardsdatascience.com%2Fhow-to-properly-ship-and-deploy-your-machine-learning-model-8a8664b763c4&amp;source=--------------------------bookmark_header-----------" rel="noopener follow"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" class="au de aw iq ay az ba ir bc hv cd o ao is it il"><svg aria-label="Add to list bookmark button" class="ii" fill="none" height="25" viewbox="0 0 25 25" width="25"><path d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18V2.5zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4V7z" fill="#292929"></path></svg><p class="bm b bn bo cn">Save</p></button></a></span></div><div class="iu l fr"><div><div aria-hidden="false" class="ci"><button aria-label="Share on twitter" class="au av aw ax ay az ba bb bc bd be bf bg bh bi"><span class="ci if dw ig"><svg fill="none" height="24" viewbox="0 0 24 24" width="24"><path d="M20 5.34c-.67.41-1.4.7-2.18.87a3.45 3.45 0 0 0-5.02-.1 3.49 3.49 0 0 0-1.02 2.47c0 .28.03.54.07.8a9.91 9.91 0 0 1-7.17-3.66 3.9 3.9 0 0 0-.5 1.74 3.6 3.6 0 0 0 1.56 2.92 3.36 3.36 0 0 1-1.55-.44V10c0 1.67 1.2 3.08 2.8 3.42-.3.06-.6.1-.94.12l-.62-.06a3.5 3.5 0 0 0 3.24 2.43 7.34 7.34 0 0 1-4.36 1.49l-.81-.05a9.96 9.96 0 0 0 5.36 1.56c6.4 0 9.91-5.32 9.9-9.9v-.5c.69-.49 1.28-1.1 1.74-1.81-.63.3-1.3.48-2 .56A3.33 3.33 0 0 0 20 5.33" fill="#A8A8A8"></path></svg></span></button></div></div></div><div class="iu l fr"><div><div aria-hidden="false" class="ci"><button aria-label="Share on facebook" class="au av aw ax ay az ba bb bc bd be bf bg bh bi"><span class="ci if dw ig"><svg fill="none" height="24" viewbox="0 0 24 24" width="24"><path d="M19.75 12.04c0-4.3-3.47-7.79-7.75-7.79a7.77 7.77 0 0 0-5.9 12.84 7.77 7.77 0 0 0 4.69 2.63v-5.49h-1.9v-2.2h1.9v-1.62c0-1.88 1.14-2.9 2.8-2.9.8 0 1.49.06 1.69.08v1.97h-1.15c-.91 0-1.1.43-1.1 1.07v1.4h2.17l-.28 2.2h-1.88v5.52a7.77 7.77 0 0 0 6.7-7.71" fill="#A8A8A8"></path></svg></span></button></div></div></div><div class="iu l fr"><div><div aria-hidden="false" class="ci"><button aria-label="Share on linkedin" class="au av aw ax ay az ba bb bc bd be bf bg bh bi"><span class="ci if dw ig"><svg fill="none" height="24" viewbox="0 0 24 24" width="24"><path d="M19.75 5.39v13.22a1.14 1.14 0 0 1-1.14 1.14H5.39a1.14 1.14 0 0 1-1.14-1.14V5.39a1.14 1.14 0 0 1 1.14-1.14h13.22a1.14 1.14 0 0 1 1.14 1.14zM8.81 10.18H6.53v7.3H8.8v-7.3zM9 7.67a1.31 1.31 0 0 0-1.3-1.32h-.04a1.32 1.32 0 0 0 0 2.64A1.31 1.31 0 0 0 9 7.71v-.04zm8.46 5.37c0-2.2-1.4-3.05-2.78-3.05a2.6 2.6 0 0 0-2.3 1.18h-.07v-1h-2.14v7.3h2.28V13.6a1.51 1.51 0 0 1 1.36-1.63h.09c.72 0 1.26.45 1.26 1.6v3.91h2.28l.02-4.43z" fill="#A8A8A8"></path></svg></span></button></div></div></div><div class="l fr"><div><div aria-hidden="false" class="ci"><button class="au av aw ax ay az ba bb bc bd be bf bg bh bi"><span class="ci if dw ig"><svg fill="none" height="24" viewbox="0 0 24 24" width="24"><path clip-rule="evenodd" d="M3.57 14.67c0-.57.13-1.11.38-1.6l.02-.02v-.02l.02-.02c0-.02 0-.02.02-.02.12-.26.3-.52.57-.8L7.78 9v-.02l.01-.02c.44-.41.91-.7 1.44-.85a4.87 4.87 0 0 0-1.19 2.36A5.04 5.04 0 0 0 8 11.6L6.04 13.6c-.19.19-.32.4-.38.65a2 2 0 0 0 0 .9c.08.2.2.4.38.57l1.29 1.31c.27.28.62.42 1.03.42.42 0 .78-.14 1.06-.42l1.23-1.25.79-.78 1.15-1.16c.08-.09.19-.22.28-.4.1-.2.15-.42.15-.67 0-.16-.02-.3-.06-.45l-.02-.02v-.02l-.07-.14s0-.03-.04-.06l-.06-.13-.02-.02c0-.02 0-.03-.02-.05a.6.6 0 0 0-.14-.16l-.48-.5c0-.04.02-.1.04-.15l.06-.12 1.17-1.14.09-.09.56.57c.02.04.08.1.16.18l.05.04.03.06.04.05.03.04.04.06.1.14.02.02c0 .02.01.03.03.04l.1.2v.02c.1.16.2.38.3.68a1 1 0 0 1 .04.25 3.2 3.2 0 0 1 .02 1.33 3.49 3.49 0 0 1-.95 1.87l-.66.67-.97.97-1.56 1.57a3.4 3.4 0 0 1-2.47 1.02c-.97 0-1.8-.34-2.49-1.03l-1.3-1.3a3.55 3.55 0 0 1-1-2.51v-.01h-.02v.02zm5.39-3.43c0-.19.02-.4.07-.63.13-.74.44-1.37.95-1.87l.66-.67.97-.98 1.56-1.56c.68-.69 1.5-1.03 2.47-1.03.97 0 1.8.34 2.48 1.02l1.3 1.32a3.48 3.48 0 0 1 1 2.48c0 .58-.11 1.11-.37 1.6l-.02.02v.02l-.02.04c-.14.27-.35.54-.6.8L16.23 15l-.01.02-.01.02c-.44.42-.92.7-1.43.83a4.55 4.55 0 0 0 1.23-3.52L18 10.38c.18-.21.3-.42.35-.65a2.03 2.03 0 0 0-.01-.9 1.96 1.96 0 0 0-.36-.58l-1.3-1.3a1.49 1.49 0 0 0-1.06-.42c-.42 0-.77.14-1.06.4l-1.2 1.27-.8.8-1.16 1.15c-.08.08-.18.21-.29.4a1.66 1.66 0 0 0-.08 1.12l.02.03v.02l.06.14s.01.03.05.06l.06.13.02.02.01.02.01.02c.05.08.1.13.14.16l.47.5c0 .04-.02.09-.04.15l-.06.12-1.15 1.15-.1.08-.56-.56a2.3 2.3 0 0 0-.18-.19c-.02-.01-.02-.03-.02-.04l-.02-.02a.37.37 0 0 1-.1-.12c-.03-.03-.05-.04-.05-.06l-.1-.15-.02-.02-.02-.04-.08-.17v-.02a5.1 5.1 0 0 1-.28-.69 1.03 1.03 0 0 1-.04-.26c-.06-.23-.1-.46-.1-.7v.01z" fill="#A8A8A8" fill-rule="evenodd"></path></svg></span></button></div></div></div></div></header><span class="l"></span><section><div><div class="fo as ja jb jc jd"></div><div class="je jf jg jh ji"><div class=""><h1 class="pw-post-title jj jk jl bm jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ga" id="bf13">How to properly ship and deploy your machine learning model</h1></div><div class=""><h2 class="pw-subtitle-paragraph ki jk jl bm b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz cn" id="9145">A practical guide with FastAPI, Docker and GitHub Actions</h2></div><figure class="lb lc ld le gx lf gl gm paragraph-image"><div class="lg lh do li ce lj" role="button" tabindex="0"><div class="gl gm la"><picture><source data-testid="og" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" srcset="https://miro.medium.com/max/640/1*NyExPzjOGaVpRBEcBkpkjQ.jpeg 640w, https://miro.medium.com/max/720/1*NyExPzjOGaVpRBEcBkpkjQ.jpeg 720w, https://miro.medium.com/max/750/1*NyExPzjOGaVpRBEcBkpkjQ.jpeg 750w, https://miro.medium.com/max/786/1*NyExPzjOGaVpRBEcBkpkjQ.jpeg 786w, https://miro.medium.com/max/828/1*NyExPzjOGaVpRBEcBkpkjQ.jpeg 828w, https://miro.medium.com/max/1100/1*NyExPzjOGaVpRBEcBkpkjQ.jpeg 1100w, https://miro.medium.com/max/1400/1*NyExPzjOGaVpRBEcBkpkjQ.jpeg 1400w"/><img alt="" class="ce lk ll c" height="394" loading="eager" role="presentation" width="700"/></picture></div></div><figcaption class="lm bl gn gl gm ln lo bm b bn bo cn">Photo by <a class="au lp" href="https://www.pexels.com/@tomfisk" rel="noopener ugc nofollow" target="_blank">Tom Fisk</a> on <a class="au lp" href="https://www.pexels.com" rel="noopener ugc nofollow" target="_blank">Pexels</a></figcaption></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="97d3">As a data scientist, training your machine learning model is only a part of providing a solution for the client. Besides generating and cleaning the data, selecting and tuning the algorithms, you also need to deliver and deploy your results so that it is usable in production. This is a large field in itself with constantly evolving tools and standards. In this post, my goal is to present a practical guide on how to do this using the currently available state of the art tools and best practices. We are going to build a system which can serve as a starting point for your deployment tasks, regardless of the actual machine learning problem itself! Instead of a minimal app barely scratching the surface of the used tools, I aim to introduce best practices and demonstrate advanced features, so that you don’t have to learn the hard way. Learning from your own mistakes is nice, but thinking ahead and not committing those mistakes is much better.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="7141">To create our deployment-ready application, we will use two tools as our main building blocks: <a class="au lp" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank">Docker</a> and <a class="au lp" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank">FastAPI</a>. Docker, which probably needs no introduction, is a containerization tool allowing you to easily package and run your application in any environment. It works especially well with FastAPI, which have gained incredible popularity in the last few months. It makes building a web framework around your model and tailoring to your customer’s needs easy.</p><div class="mm mn gt gv mo mp"><a href="/you-should-start-using-fastapi-now-7efb280fec02" rel="noopener follow" target="_blank"><div class="mq o fr"><div class="mr o da dx en ms"><h2 class="bm jm dm bo fs mt fu fv mu fx fz jk ga">You Should Start Using FastAPI Now</h2><div class="mv l"><h3 class="bm b dm bo fs mt fu fv mu fx fz cn">If you haven’t tried FastAPI yet, it is time</h3></div><div class="mw l"><p class="bm b hi bo fs mt fu fv mu fx fz cn">towardsdatascience.com</p></div></div><div class="mx l"><div class="my l mz na nb mx nc lk mp"></div></div></div></a></div><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="175e">Our toy problem will be a simple regression, where we will predict real estate prices based on 13 features such as crime rate, property tax rate, etc. For this, we will use the <a class="au lp" href="https://scikit-learn.org/stable/datasets/index.html#boston-dataset" rel="noopener ugc nofollow" target="_blank">Boston house prices dataset</a> as our training data. Regarding the model choice, we will use a <a class="au lp" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html" rel="noopener ugc nofollow" target="_blank">random forest regressor</a> from the awesome <a class="au lp" href="https://scikit-learn.org/stable/index.html" rel="noopener ugc nofollow" target="_blank">scikit-learn</a> package. Of course, you are not restricted to scikit-learn, you can use TensorFlow, PyTorch, or whatever you may like. I choose this for simplicity, since it requires almost no extra work like extensive data preprocessing and its dependencies are relatively lightweight and easy to install.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="68cc">In this post, I would like to demonstrate how to</p><ul class=""><li class="nd ne jl ls b lt lu lw lx lz nf md ng mh nh ml ni nj nk nl ga" id="db2d">package your model and build an API to communicate with it,</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml ni nj nk nl ga" id="69a6">design a convenient and simple user interface,</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml ni nj nk nl ga" id="73a8">set up a proper development environment with <code class="fp nr ns nt nu b">virtualenv</code>,</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml ni nj nk nl ga" id="fb9d">use FastAPI,</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml ni nj nk nl ga" id="a066">prepare for future code changes by wrapping your machine learning model,</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml ni nj nk nl ga" id="9ba7">use dependency injection to make testing easier,</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml ni nj nk nl ga" id="39c1">validate user input,</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml ni nj nk nl ga" id="4153">test the API properly with mocks,</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml ni nj nk nl ga" id="f9a8">package it up with Docker and Docker compose,</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml ni nj nk nl ga" id="e921">and finally how to use GitHub Actions to automate testing.</li></ul><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="470c">To follow this guide, you don’t have to have experience with Docker or FastAPI at all! Some familiarity with scikit-learn and NumPy will be beneficial, but we won’t focus on these parts very intensively. The application which we are going to build can be found in its entirety at <a class="au lp" href="https://github.com/cosmic-cortex/fastAPI-ML-quickstart" rel="noopener ugc nofollow" target="_blank">https://github.com/cosmic-cortex/fastAPI-ML-quickstart</a>, ready to use. Before we jump straight into the development, let’s assess the requirements and design the architecture of the application!</p><h1 class="nv nw jl bm nx ny nz oa ob oc od oe of kr og ks oh ku oi kv oj kx ok ky ol om ga" id="4889">How to design a small machine learning app</h1><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="aaf1">One of the main considerations during deployment is the need of the customer. In our case, let’s assume that they don’t need to understand how the algorithm works and don’t want to retrain the algorithm. They just want to send the data and get back the answer right away.</p><figure class="lb lc ld le gx lf gl gm paragraph-image"><div class="lg lh do li ce lj" role="button" tabindex="0"><div class="gl gm os"><picture><source data-testid="og" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" srcset="https://miro.medium.com/max/640/1*sutI0FqeIaoWuI_xdLTSJA.png 640w, https://miro.medium.com/max/720/1*sutI0FqeIaoWuI_xdLTSJA.png 720w, https://miro.medium.com/max/750/1*sutI0FqeIaoWuI_xdLTSJA.png 750w, https://miro.medium.com/max/786/1*sutI0FqeIaoWuI_xdLTSJA.png 786w, https://miro.medium.com/max/828/1*sutI0FqeIaoWuI_xdLTSJA.png 828w, https://miro.medium.com/max/1100/1*sutI0FqeIaoWuI_xdLTSJA.png 1100w, https://miro.medium.com/max/1400/1*sutI0FqeIaoWuI_xdLTSJA.png 1400w"/><img alt="" class="ce lk ll c" height="285" loading="lazy" role="presentation" width="700"/></picture></div></div><figcaption class="lm bl gn gl gm ln lo bm b bn bo cn">Communicating with the machine learning model</figcaption></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="a273">In technical terms, we are going to build an application which receives data in form of HTTP requests and sends back the predictions as HTTP responses. Besides its simple interface, it is easy to integrate into a larger application as a microservice, which is a huge advantage.</p><figure class="lb lc ld le gx lf gl gm paragraph-image"><div class="lg lh do li ce lj" role="button" tabindex="0"><div class="gl gm ot"><picture><source data-testid="og" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" srcset="https://miro.medium.com/max/640/1*IPci3RFJjf0nWPsTqxy_mQ.png 640w, https://miro.medium.com/max/720/1*IPci3RFJjf0nWPsTqxy_mQ.png 720w, https://miro.medium.com/max/750/1*IPci3RFJjf0nWPsTqxy_mQ.png 750w, https://miro.medium.com/max/786/1*IPci3RFJjf0nWPsTqxy_mQ.png 786w, https://miro.medium.com/max/828/1*IPci3RFJjf0nWPsTqxy_mQ.png 828w, https://miro.medium.com/max/1100/1*IPci3RFJjf0nWPsTqxy_mQ.png 1100w, https://miro.medium.com/max/1400/1*IPci3RFJjf0nWPsTqxy_mQ.png 1400w"/><img alt="" class="ce lk ll c" height="232" loading="lazy" role="presentation" width="700"/></picture></div></div><figcaption class="lm bl gn gl gm ln lo bm b bn bo cn">The application from a high level</figcaption></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="3143">Our application will communicate through an API, which will be packaged in a Docker container. Within the application itself, we need to do three things in this simple case: process the input, make the predictions, process the output and return it to the user. With FastAPI, the input will be a JSON, something like this:</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="d4da">{<strong class="nu jm"><br/>  </strong>"data":[[0.00632,18,2.31,0,0.538,6.575,65.2,4.09,1,296,15.3,396.9,4.98]]<strong class="nu jm"><br/></strong>}</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="35c5">This will be converted by FastAPI internally to an appropriate Python object. (More on this later, as this is one of the neatest features in FastAPI.) We need to process this for the scikit-learn model, which means converting it to a NumPy array. It can be used to calculate our predictions, which we will again turn into a format used by FastAPI. In the end, the user will receive a JSON similar to the input:</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="2151">{<strong class="nu jm"><br/>  </strong>"data": [25.813999999999993]<strong class="nu jm"><br/></strong>}</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="7442">Let’s jump into the development right away! Our first job is to set up the appropriate development environment.</p><h1 class="nv nw jl bm nx ny nz oa ob oc od oe of kr og ks oh ku oi kv oj kx ok ky ol om ga" id="daa9">Setting up the development environment</h1><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="0cb3">If you have worked with Python extensively, you have probably used virtual environments. If not, the gist is the following. A Python virtual environment is an isolated installation of Python, where you can install packages needed specifically for the project. When you have many projects with possibly conflicting dependencies (like if one requires NumPy ≥ 1.13 and other requires NumPy ≤ 1.10), you are better off using a virtual environment to avoid jumbling things completely. To create a virtual environment, use</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="6cbc">virtualenv /path/to/venv --python=/path/to/python3</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="c07a">where the path to your global Python3 interpreter can be found with</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="7511">which python3</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="d143">if you are under Linux. (If you don’t provide the interpreter explicitly, it will fall back to the Python interpreter with the alias <code class="fp nr ns nt nu b">python</code>, which can be Python 2.7 in some cases. Don’t use Python 2.7 :) ) The virtual environment can be activated with</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="b97d">source /path/to/venv/bin/activate</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="553c">and after this, if you install packages with <em class="pc">pip</em>, it will only be visible while the virtual environment is active. After you have cloned <a class="au lp" href="https://github.com/cosmic-cortex/fastAPI-ML-quickstart" rel="noopener ugc nofollow" target="_blank">the repository containing the application which we will build</a>, you can install the dependencies with the</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="0021">pip install -r requirements.txt</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="bc02">command while in the root folder. Although you don’t need to collect your dependencies into a single requirements file, it is strongly advised to do so. It makes maintaining your application more easy, moreover you can use the same file when packaging the application into a Docker image.</p><h1 class="nv nw jl bm nx ny nz oa ob oc od oe of kr og ks oh ku oi kv oj kx ok ky ol om ga" id="b546">Building the skeleton of the application</h1><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="13e8">Roughly speaking, every FastAPI application consists of a main file responsible for launching the application/defining the endpoints and additional modules which are used by the endpoints. (The endpoints can be defined elsewhere other than the main file, but in the simplest cases this structure is preferable.)</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="e67e">.<br/>├── api<br/>│   ├── __init__.py<br/>│   ├── main.py<br/>│   └── ml<br/>│       ├── __init__.py<br/>│       ├── model.joblib<br/>│       └── model.py<br/>└── requirements.txt</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="1ecf">Let’s build the skeleton of <code class="fp nr ns nt nu b">main.py</code> first and implement the <code class="fp nr ns nt nu b">ml</code> module later, when the structure of FastAPI apps are clear!</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="2873">We basically need to import two classes: the <code class="fp nr ns nt nu b">FastAPI</code> class which provides all functionality for our API and the <code class="fp nr ns nt nu b">BaseModel</code> from the awesome Pydantic library, which serves as a model for HTTP requests and responses.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="e83d">After instantiating a <code class="fp nr ns nt nu b">FastAPI</code> object, we can register endpoints to it by using its appropriate methods to decorate our functions describing the endpoint logic. For example, here we have</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="dfc5">which means that our application expects a <code class="fp nr ns nt nu b">POST</code>request to the <code class="fp nr ns nt nu b">/predict</code> endpoint containing a JSON payload with structure described by the <code class="fp nr ns nt nu b">PredictRequest</code> object, and will return a response with a JSON payload described by <code class="fp nr ns nt nu b">PredictResponse</code>. These are all specified by the <code class="fp nr ns nt nu b">@app.post</code> decorator before the function, which will register this function to the <code class="fp nr ns nt nu b">FastAPI</code> instance named <code class="fp nr ns nt nu b">app</code> and routes the requests to the <code class="fp nr ns nt nu b">/predict</code> URL to this function. The type annotation for the <code class="fp nr ns nt nu b">input</code> argument of <code class="fp nr ns nt nu b">predict</code> describes the appropriate format of the request data.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="6295">In this example, a <code class="fp nr ns nt nu b">PredictRequest</code> object has a single attribute called <code class="fp nr ns nt nu b">data</code>, which must be a list of list of floats. (Since data is usually passed in batches, each list inside the external list is a data point.) Pydantic takes type checks seriously: if the type does not match, it relentlessly throws an exception. This type checking with Pydantic is an extremely powerful feature of FastAPI, making our life much easier. If the request does not have the proper form, you instantly receive a 422 Unprocessable Entity status code as a response. And you have to do almost zero work for this! FastAPI and Pydantic performs the validations for you if you have specified the schema using the request and response models.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="32eb">You can serve this app right away with</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="862a">uvicorn api.main:app</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="cb7b">and try out the endpoints by checking out the automatic documentation generated by FastAPI, which can be found at <a class="au lp" href="http://localhost:8000/docs" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/docs</a> by default. Alternatively, you can use <code class="fp nr ns nt nu b">curl</code> to post requests, for example</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="fff2">curl -X POST “<a class="au lp" href="http://localhost:8000/predict" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/predict</a>" -H “accept: application/json” -H “Content-Type: application/json” -d “{\”data\”:[[0]]}”</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="bfa0">will work. Currently, this simple skeleton will always return a dummy response</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="4bb4">{<strong class="nu jm"><br/>  </strong>"data":<strong class="nu jm"> </strong>[0]<strong class="nu jm"><br/></strong>}</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="0ab6">but this will change soon, once our model is in place. Now that the skeleton is up and running, we are ready to implement the machine learning model!</p><h1 class="nv nw jl bm nx ny nz oa ob oc od oe of kr og ks oh ku oi kv oj kx ok ky ol om ga" id="96a5">Creating a machine learning algorithm</h1><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="522c">As I have mentioned, we are going to train a simple <a class="au lp" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html" rel="noopener ugc nofollow" target="_blank">random forest regressor</a> using the <a class="au lp" href="https://scikit-learn.org/stable/datasets/index.html#boston-dataset" rel="noopener ugc nofollow" target="_blank">Boston dataset</a>, both can be found in scikit-learn. Although it is tempting to work with the scikit-learn objects directly, I prefer to build an abstract interface for our models, which will be used by the API endpoints instead of the the scikit-learn object itself. The reasoning behind it is the interface is reusable throughout your entire codebase, and if you wish to replace your underlying model (say use a PyTorch model instead of the random forest regressor of scikit-learn), you only need to change the implementation of this class instead of changing all the functions and endpoints actually using the model.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="c991">We need four essential methods: one to train the model, one to calculate the predictions and two for saving and loading the model. When the interface is clear, we can proceed with the concrete implementation, which is very straightforward.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="82e3">In addition to the Model interface itself, we will also define the model object in the <code class="fp nr ns nt nu b">api.ml.model</code> module. This particular instance will be used throughout the application. This is called a singleton, which is one of the most important OOP patterns. Although it is safe to use here, singletons must be used with caution in larger applications, since they are basically global variables. This model object is accessed in the rest of the application by calling the <code class="fp nr ns nt nu b">get_model()</code> function. The reason for this is twofold. First, this function is reusable in the code everywhere, thus if later we decide to add additional logic to getting the model (like checks, etc), it is enough to modify the code in a single place. Second, which will be explained later, it is better to write unit tests for the application if we use <a class="au lp" href="https://fastapi.tiangolo.com/tutorial/dependencies/" rel="noopener ugc nofollow" target="_blank">dependency injection</a> in the endpoints. (Don’t worry if you don’t understand this now, it will be explained later.)</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="3692">To prepare our application, a model is trained and saved to the disk when this script is executed. This will be used later for prediction.</p><h1 class="nv nw jl bm nx ny nz oa ob oc od oe of kr og ks oh ku oi kv oj kx ok ky ol om ga" id="78bf">Building the API endpoints I: processing JSON input</h1><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="c2cd">After the app skeleton and the machine learning algorithm is in place, we are ready to implement the logic behind the endpoints. Let’s switch back to the <code class="fp nr ns nt nu b">main.py</code> module! The prediction is a relatively straightforward process, which can be implemented using only a few lines of code.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="818c">In the function body, there are three things going on:</p><ol class=""><li class="nd ne jl ls b lt lu lw lx lz nf md ng mh nh ml pf nj nk nl ga" id="ab77">The input (which is an instance of <code class="fp nr ns nt nu b">PredictRequest</code>) is converted to a NumPy array.</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml pf nj nk nl ga" id="b94d">Predictions are calculated, resulting in a NumPy array.</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml pf nj nk nl ga" id="2055">Results are converted to a <code class="fp nr ns nt nu b">PredictResponse</code> object and returned.</li></ol><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="6fb4">The return value is converted to a proper response by FastAPI. There is one important change which probably already got your attention: we pass an additional parameter to our <code class="fp nr ns nt nu b">predict</code> function:</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="b923">model: Model = Depends(get_model)</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="7689">where the <code class="fp nr ns nt nu b">get_model</code> function is the one which returns the model, defined in the <code class="fp nr ns nt nu b">api.ml.model</code> module. This technique is called dependency injection. Although <code class="fp nr ns nt nu b">model</code> is a parameter of the function, each time the <code class="fp nr ns nt nu b">predict</code> function is called, <code class="fp nr ns nt nu b">get_model</code> is executed and the return value is passed. It might not be apparent why exactly this is useful, but this is very important to write proper unit tests. Think about it: our endpoint depends on a scikit-learn object, which has thousands of lines of code behind it. It can break in new releases of the package for example. (As it happened with pip very recently: <a class="au lp" href="https://github.com/pypa/pip/issues/7217" rel="noopener ugc nofollow" target="_blank">https://github.com/pypa/pip/issues/7217</a>, affecting a significant portion of users.) In general, however important they are, external dependencies carry potential errors. When we want to unit test our application, we don’t want the results to depend on the correctness of some object which might be outside of our control. Thus, these are usually mocked during unit tests. A mock is a fake object, implementing the same interface as the original, having 100% predictable behavior. With dependency injection, these mocks can be easily injected into the code by overriding the dependencies. Don’t worry if you don’t get this right away, it will be explained in more detail in the testing section.</p><h1 class="nv nw jl bm nx ny nz oa ob oc od oe of kr og ks oh ku oi kv oj kx ok ky ol om ga" id="3ce3">Never trust the user input</h1><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="628d">Now that the endpoint itself is implemented, let’s consider some possible use cases. If you try</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="8017">curl -X POST “<a class="au lp" href="http://localhost:8000/predict" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/predict</a>" -H “accept: application/json” -H “Content-Type: application/json” -d “{\”data\”:[[0]]}”</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="3280">using the current implementation, you will get an Internal Server Error and the application will crash. This is because since the model was trained using 13 features, it requires 13 features for prediction. Although uvicorn is smart and will restart your application in this case, Internal Server Error is as bad as it sounds and you definitely don’t want to experience this in production. To fix this issue, we will add additional validation to our Pydantic request models. By default, they only check that the JSON payload has a “data” key, whose value is a list of list of floats. In our <a class="au lp" href="https://pydantic-docs.helpmanual.io/usage/validators/" rel="noopener ugc nofollow" target="_blank">custom validator</a> (which runs in addition to the default validation), we check that the dimensionality of the data is correct, that is, every sublist contains exactly <code class="fp nr ns nt nu b">n_features</code> elements. (Which is 13.)</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="84c4">When wrong data is passed and the validation fails, the app won’t crash but returns a 422 Unprocessable Entity error code instead. Although this is not necessarily a better result for the enduser, it is definitely more pleasant for you and your devops team. In general, when you are building applications which process data, you should never trust user input. Things can go wrong accidentally or by malicious attacks such as <a class="au lp" href="https://en.wikipedia.org/wiki/SQL_injection" rel="noopener ugc nofollow" target="_blank">SQL injections</a>, which was a popular and dangerous tool in a hacker’s toolkit.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="22e9">The final module will look something like this: <a class="au lp" href="https://github.com/cosmic-cortex/fastAPI-ML-quickstart/blob/master/api/main.py" rel="noopener ugc nofollow" target="_blank">https://github.com/cosmic-cortex/fastAPI-ML-quickstart/blob/master/api/main.py</a></p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="af56">The <code class="fp nr ns nt nu b">predict_csv</code> endpoint will be added in the next section.</p><h1 class="nv nw jl bm nx ny nz oa ob oc od oe of kr og ks oh ku oi kv oj kx ok ky ol om ga" id="efff">Building the API endpoints II: processing .csv files</h1><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="4a3f">If you would like to receive data in another format, such as a csv file, you can do that. Instead of using a Pydantic model as input, you should use <code class="fp nr ns nt nu b"><a class="au lp" href="https://fastapi.tiangolo.com/tutorial/request-files/" rel="noopener ugc nofollow" target="_blank">File</a></code><a class="au lp" href="https://fastapi.tiangolo.com/tutorial/request-files/" rel="noopener ugc nofollow" target="_blank"> and </a><code class="fp nr ns nt nu b"><a class="au lp" href="https://fastapi.tiangolo.com/tutorial/request-files/" rel="noopener ugc nofollow" target="_blank">UploadFile</a></code> for that purpose.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="8abe">Notice that this time, Pydantic is not there to perform validation for us, thus we must do it manually. There are two things which needs to be validated.</p><ol class=""><li class="nd ne jl ls b lt lu lw lx lz nf md ng mh nh ml pf nj nk nl ga" id="27ea">The file contains data in a tabular form.</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml pf nj nk nl ga" id="8ebc">The data contains exactly 13 features.</li></ol><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="8ffa">We do both manually inside the function body. When something is wrong, we raise an exception, which is returned by FastAPI in a proper HTTP response.</p><h1 class="nv nw jl bm nx ny nz oa ob oc od oe of kr og ks oh ku oi kv oj kx ok ky ol om ga" id="533f">Testing the API</h1><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="6193">Now that we have everything in place, it is time to test our application! Working with untested code is like a Whack-A-Mole game: you fix one bug, another one will be introduced right away. Personally, I am a big proponent of testing and I think you should be one too. Although testing requires an initial time investment, it will pay off exponentially later in development.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="897f">To test the API, we will use <code class="fp nr ns nt nu b">pytest</code>, which is a standard tool for unit testing in Python. We will put the tests module right next to the <code class="fp nr ns nt nu b">api</code>, so the file structure will look like this:</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="ebe4">.<br/>├── api<br/>│   ├── __init__.py<br/>│   ├── main.py<br/>│   ├── ml<br/>│   │   ├── __init__.py<br/>│   │   ├── model.joblib<br/>│   │   └── model.py<br/>│   └── tests<br/>│       ├── api<br/>│       │   ├── __init__.py<br/>│       │   └── test_api.py<br/>│       ├── conftest.py<br/>│       ├── __init__.py<br/>│       └── mocks.py<br/>└── requirements.txt</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="af46">The first thing which we shall build is a mock <code class="fp nr ns nt nu b">Model</code> object, so that our endpoint tests doesn’t depend on scikit-learn. As I have mentioned, this would be undesirable, since we want to decouple bugs in our code and bugs in external code.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="ee6f">This class is relatively straightforward, completely mimics the interface of our <code class="fp nr ns nt nu b">api.ml.model.Model</code> class, but basically it does not perform any meaningful computation and returns random data. (Although the random data will match the expected output in shape.)</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="ab62">Next, we will add the test configuration, which is located in the <code class="fp nr ns nt nu b">conftest.py</code> module, by <code class="fp nr ns nt nu b">pytest</code> requirements. In our case, we should do two things.</p><ol class=""><li class="nd ne jl ls b lt lu lw lx lz nf md ng mh nh ml pf nj nk nl ga" id="d4d5">Overwrite the dependency injection used in the endpoint to use a <code class="fp nr ns nt nu b">MockModel</code> object instead of a real model.</li><li class="nd ne jl ls b lt nm lw nn lz no md np mh nq ml pf nj nk nl ga" id="1200">Define the fixtures, which are dependency injections themselves, used in tests. (We will see an example soon.)</li></ol><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="a32c">First, we import the actual <code class="fp nr ns nt nu b">app</code> object from our <code class="fp nr ns nt nu b">main</code> module. To override the dependency to <code class="fp nr ns nt nu b">get_model()</code>, we simply provide a new function and set the appropriate key in the <code class="fp nr ns nt nu b">app.dependency_overrides</code> dictionary with the new function. This code won’t execute during deployment, thus our dependencies won’t be overridden by accident, it is specific for tests. Next, we prepare a Starlette <code class="fp nr ns nt nu b">TestClient</code>, which <a class="au lp" href="https://www.starlette.io/testclient/" rel="noopener ugc nofollow" target="_blank">“allows you to make requests against your ASGI application”</a>, a very convenient tool for testing. This definition means that with a <code class="fp nr ns nt nu b">TestClient</code> instance, we can post requests to endpoints and receive the responses, which is exactly what we want to test.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="bedd">First, we test the user input with valid data. To see that it works well with multiple batch sizes (from 1 to 9), we add the number of data points as the <code class="fp nr ns nt nu b">n_instances</code> parameter. Looping through all the possible sizes inside the test function is considered bad practice, since if it fails for a particular size, you would like to know where it failed exactly. Thus, we can use the <code class="fp nr ns nt nu b">@pytest.mark.parametrize</code> decorator, which automatically generates a new test function for each value of the parameter. Inside the test function, we simply generate some fake data and post it to the application using the <code class="fp nr ns nt nu b">TestClient</code>. We want to check two things: 1) the response code is 200, which is HTTP-speak for A-okay 2) the response contains as many predictions as the size of our input dataset.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="ab48">However, testing the endpoint for correct input data is not enough. If so, it is even more important to make sure our application behaves properly when presented with incorrect data. This is presented below.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="7b5b">For completeness, I have added tests for the <code class="fp nr ns nt nu b">predict_csv</code> endpoint, these are similar to the previous ones, so I won’t detail them.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="acf0">Once the tests are ready, you can run them by simply executing <code class="fp nr ns nt nu b">pytest</code> in bash from the root directory of the project. The output will be along the following lines:</p><figure class="lb lc ld le gx lf gl gm paragraph-image"><div class="lg lh do li ce lj" role="button" tabindex="0"><div class="gl gm pg"><picture><source data-testid="og" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" srcset="https://miro.medium.com/max/640/1*8eSgQlFPaSeowrOQkNPzHQ.png 640w, https://miro.medium.com/max/720/1*8eSgQlFPaSeowrOQkNPzHQ.png 720w, https://miro.medium.com/max/750/1*8eSgQlFPaSeowrOQkNPzHQ.png 750w, https://miro.medium.com/max/786/1*8eSgQlFPaSeowrOQkNPzHQ.png 786w, https://miro.medium.com/max/828/1*8eSgQlFPaSeowrOQkNPzHQ.png 828w, https://miro.medium.com/max/1100/1*8eSgQlFPaSeowrOQkNPzHQ.png 1100w, https://miro.medium.com/max/1400/1*8eSgQlFPaSeowrOQkNPzHQ.png 1400w"/><img alt="" class="ce lk ll c" height="453" loading="lazy" role="presentation" width="700"/></picture></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="f59b">After all, the tests module should look like this: <a class="au lp" href="https://github.com/cosmic-cortex/fastAPI-ML-quickstart/tree/master/api/tests" rel="noopener ugc nofollow" target="_blank">https://github.com/cosmic-cortex/fastAPI-ML-quickstart/tree/master/api/tests</a>.</p><h1 class="nv nw jl bm nx ny nz oa ob oc od oe of kr og ks oh ku oi kv oj kx ok ky ol om ga" id="7ad6">Packaging your application</h1><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="1f79">When the application is properly tested and runs correctly in your local machine, it is time to package it into a portable format. Without this, setting this up on another machine can be a slow and painful process. For this purpose, we are going to use Docker.</p><figure class="lb lc ld le gx lf gl gm paragraph-image"><div class="lg lh do li ce lj" role="button" tabindex="0"><div class="gl gm ph"><picture><source data-testid="og" sizes="(min-resolution: 4dppx) and (max-width: 700px) 50vw, (-webkit-min-device-pixel-ratio: 4) and (max-width: 700px) 50vw, (min-resolution: 3dppx) and (max-width: 700px) 67vw, (-webkit-min-device-pixel-ratio: 3) and (max-width: 700px) 65vw, (min-resolution: 2.5dppx) and (max-width: 700px) 80vw, (-webkit-min-device-pixel-ratio: 2.5) and (max-width: 700px) 80vw, (min-resolution: 2dppx) and (max-width: 700px) 100vw, (-webkit-min-device-pixel-ratio: 2) and (max-width: 700px) 100vw, 700px" srcset="https://miro.medium.com/max/640/1*Yfe1eQBGZC6nOi-_fbn0xA.png 640w, https://miro.medium.com/max/720/1*Yfe1eQBGZC6nOi-_fbn0xA.png 720w, https://miro.medium.com/max/750/1*Yfe1eQBGZC6nOi-_fbn0xA.png 750w, https://miro.medium.com/max/786/1*Yfe1eQBGZC6nOi-_fbn0xA.png 786w, https://miro.medium.com/max/828/1*Yfe1eQBGZC6nOi-_fbn0xA.png 828w, https://miro.medium.com/max/1100/1*Yfe1eQBGZC6nOi-_fbn0xA.png 1100w, https://miro.medium.com/max/1400/1*Yfe1eQBGZC6nOi-_fbn0xA.png 1400w"/><img alt="" class="ce lk ll c" height="366" loading="lazy" role="presentation" width="700"/></picture></div></div><figcaption class="lm bl gn gl gm ln lo bm b bn bo cn">Docker architecture. Source: <a class="au lp" href="https://docs.docker.com/engine/docker-overview/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/engine/docker-overview/</a></figcaption></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="41da">Docker packages applications into <em class="pc">images</em>, which are self-contained applications, even operating systems. They are run by Docker containers, which are isolated execution environments. They are very similar in principle to virtual machines. Although they don’t offer as strict isolation as VMs, it is a good model to think of when you are using Docker for the first time.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="930b">A Docker image is defined by the <code class="fp nr ns nt nu b">Dockerfile</code>, which is basically a set of instructions for Docker on how to build the image. Images are usually not standalone, they are built from other base images. These images have their own repository at <a class="au lp" href="https://hub.docker.com" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com</a>, where you can push your images and pull other ones. By an analogy, these images are like git repositories. Using a base image is like forking a repository and pushing a few commits to your own fork.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="240b">We are going to package our application by using the <code class="fp nr ns nt nu b">ubuntu:19.10</code> image, which contains the 19.10 version of Ubuntu. (This is the official Ubuntu docker image.) Choosing the base image significantly impacts the much of the later workflow. For Python applications, an Alpine Linux based image is also an excellent choice, Python even has some of its official images based on Alpine. However, installing NumPy and certain machine learning libraries to an Alpine based images can be difficult, so we are going to stick with Ubuntu.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="cf1a">Here is our Dockerfile, contained in the root folder of the project. We are going to walk through this line by line.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="20e2">The first line describes the base image, which is <code class="fp nr ns nt nu b">ubuntu:19.10</code> as mentioned. Upon building, this image is pulled from the central repository. After it is done, Docker is going to copy the <code class="fp nr ns nt nu b">./api</code> folder to the image. (Each image has its own filesystem.) Then we are going to install Python3 and the required packages such as FastAPI. The command after <code class="fp nr ns nt nu b">RUN</code> is executed within the image. After this, we set the <code class="fp nr ns nt nu b">PYTHONPATH</code> variable and the working directory properly.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="c680">To serve our application, we shall expose the port 8000 of the container to the host image. This is not done by default for security reasons, you have to do this manually. Finally, we tell Docker what to do when the container is run: we want to start <code class="fp nr ns nt nu b">uvicorn</code> and serve the application. The <code class="fp nr ns nt nu b">ENTRYPOINT</code> specifies the command which will be run every time the container is executed, while <code class="fp nr ns nt nu b">CMD</code> specifies its arguments.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="dbb6">The image itself can be built with the</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="2047">docker build --file Dockerfile --tag fastapi-ml-quickstart .</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="038d">command. The building can take a while, but after it is done, you can run it with</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="f199">docker run -p 8000:8000 fastapi-ml-quickstart</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="37c4">In the run command, you need to specify for Docker to map the TCP port 8000 of the container to the same one in the host machine. If you open up <a class="au lp" href="http://localhost:8000" rel="noopener ugc nofollow" target="_blank">http://localhost:8000</a> in your browser, you can see that the application is running and you can connect to it properly.</p><h2 class="ox nw jl bm nx pi pj pk ob pl pm pn of lz po pp oh md pq pr oj mh ps pt ol pu ga" id="7166">Combining containers</h2><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="eaa3">In this simple case, our application is not reliant on other services such as Redis or PostgreSQL. When it is the case, <code class="fp nr ns nt nu b">docker-compose</code> can be used to combine containers. Similarly to <code class="fp nr ns nt nu b">Dockerfile</code>, docker-compose needs a YAML configuration file named <code class="fp nr ns nt nu b">docker-compose.yaml</code> describing which services to launch.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="87fb">After this, the service can be launched with simply executing</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="9986">docker-compose up</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="b6b8">from the project root directory. Docker compose will automatically build the image when it is not available. I find that even when you have a single container, it is much simpler to use this then to call <code class="fp nr ns nt nu b">docker build</code> and <code class="fp nr ns nt nu b">docker run</code> manually every time.</p><h1 class="nv nw jl bm nx ny nz oa ob oc od oe of kr og ks oh ku oi kv oj kx ok ky ol om ga" id="e996">Continuous integration with GitHub Actions</h1><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="c38c">One of the pillars of well maintained code is continuous integration. Even though we have tests, nothing actually enforces the programmer to use them before committing the changes. We can solve this by executing tests automatically upon certain triggers like pushes and pull requests to specific branches. This way, pushing changes to the mainline of a shared codebase can be done much faster than the usual. Compared to the old school development workflow when merging is done say once per week and requires a large portion of the team to supervise it, with proper continuous integration setup, code delivery can be done by a single person even several times per day.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="6a4b">In this project we are going to use GitHub Actions, which allows you to automate actions upon predefined triggers. It requires you to define your action scripts inside the <code class="fp nr ns nt nu b">.github/workflows</code> subdirectory of the GitHub-hosted repository. The following is the <a class="au lp" href="https://github.com/cosmic-cortex/fastAPI-ML-quickstart/blob/master/.github/workflows/ci.yaml" rel="noopener ugc nofollow" target="_blank">YAML config file</a> of this project.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="fdca">As you can see, the config file has two main parts: the second part defines what is going to happen, the first part defines when. In this example, we want the script to execute on every push and every pull request to the <code class="fp nr ns nt nu b">master</code> branch.</p><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="72b3">The action itself is defined in terms of <em class="pc">jobs</em>, for which each step is given. This particular job named <code class="fp nr ns nt nu b">build</code> runs in an Ubuntu instance, as indicated by the <code class="fp nr ns nt nu b">runs-on</code> parameter. First it <a class="au lp" href="https://github.com/actions/checkout" rel="noopener ugc nofollow" target="_blank">checks out the repository</a>, then it launches Docker compose using the <code class="fp nr ns nt nu b">docker-compose.test.yaml</code> file, made specifically for testing purposes.</p><figure class="lb lc ld le gx lf"><div class="m fs l do"><div class="pd pe l"></div></div></figure><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="3789">This Docker compose is only different in one line compared to the one which we used previously: it overrides the entrypoint for the <code class="fp nr ns nt nu b">fastapi-ml-quickstart</code> container, launching <code class="fp nr ns nt nu b">pytest</code> instead of <code class="fp nr ns nt nu b">uvicorn</code>. Upon finish, the container exits and Docker compose is aborted, returning the exit code from the <code class="fp nr ns nt nu b">fastapi-ml-quickstart</code> container. These things are not the default behavior of <code class="fp nr ns nt nu b">docker-compose</code>, so you have to specifically instruct it to do so:</p><pre class="lb lc ld le gx ou bs ov ow dz nu"><span class="ga ox nw jl nu b dm oy oz l pa pb" id="3c1b">docker-compose -f docker-compose.test.yaml up --abort-on-container-exit --exit-code-from fastapi-ml-quickstart</span></pre><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="9ef4">As a personal note, I am a big fan of GitHub Actions. It is very versatile, you can even push updates to production with it, publish in PyPI, and many more other tasks. Its obvious drawback is that it is only available for GitHub users. There are alternatives however, for instance Jenkins, CircleCI, Travis CI, GitLab CI, and many more.</p><h1 class="nv nw jl bm nx ny nz oa ob oc od oe of kr og ks oh ku oi kv oj kx ok ky ol om ga" id="ca78">Wrapping up</h1><p class="pw-post-body-paragraph lq lr jl ls b lt on km lv lw oo kp ly lz op mb mc md oq mf mg mh or mj mk ml je ga" id="ff2e">In this guide, my aim was to build a small application for machine learning applications and to package it properly following best practices and using modern tools. However, there is always room for improvement! If you have any ideas, feel free to open up an issue at <a class="au lp" href="https://github.com/cosmic-cortex/fastAPI-ML-quickstart" rel="noopener ugc nofollow" target="_blank">https://github.com/cosmic-cortex/fastAPI-ML-quickstart</a>! I hope that you have found this guide useful. Now go and start building awesome AI apps :)</p></div><div class="o dx pv pw in px" role="separator"><span class="py fl ci pz qa qb"></span><span class="py fl ci pz qa qb"></span><span class="py fl ci pz qa"></span></div><div class="je jf jg jh ji"><p class="pw-post-body-paragraph lq lr jl ls b lt lu km lv lw lx kp ly lz ma mb mc md me mf mg mh mi mj mk ml je ga" id="bf01"><a class="au lp" href="https://www.tivadardanka.com/blog" rel="noopener ugc nofollow" target="_blank"><strong class="ls jm"><em class="pc">If you love taking machine learning concepts apart and understanding what makes them tick, we have a lot in common. Check out my blog, where I frequently publish technical posts like this!</em></strong></a></p></div></div></section></div></div></article>